<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendame - Faça seu Agendamento</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #8A2BE2;
            --primary-light: #a855f7;
            --primary-dark: #7c3aed;
            --dark-bg: #121212;
            --darker-bg: #0a0a0a;
            --card-dark: #1e1e1e;
            --text-light: #e0e0e0;
            --text-muted: #aaaaaa;
            --user-msg-bg: #2d2d2d;
            --bot-msg-bg: #2a1b3d;
            --accent-color: #10b981;
            --border-color: #333;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Header Styles */
        .header {
            background-color: var(--darker-bg);
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 28px;
            color: var(--primary-color);
        }

        .logo h1 {
            font-size: 24px;
            color: var(--primary-color);
            font-weight: 700;
        }

        .business-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .business-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-light);
        }

        .business-type {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 30px 0;
        }

        .chat-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .chat-header h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: var(--text-light);
        }

        .chat-header p {
            color: var(--text-muted);
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.5;
        }

        /* Chat Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: var(--card-dark);
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: 500px;
        }

        .message {
            display: flex;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bot-message {
            align-self: flex-start;
        }

        .user-message {
            align-self: flex-end;
        }

        .message-content {
            padding: 16px 20px;
            border-radius: 18px;
            line-height: 1.5;
            position: relative;
        }

        .bot-message .message-content {
            background-color: var(--bot-msg-bg);
            border-top-left-radius: 4px;
            color: var(--text-light);
        }

        .user-message .message-content {
            background-color: var(--user-msg-bg);
            border-top-right-radius: 4px;
            color: var(--text-light);
        }

        .message-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 5px;
            text-align: right;
        }

        /* Chat Input & Options */
        .chat-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .option-btn {
            background-color: var(--card-dark);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            padding: 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            font-size: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .option-btn:hover {
            background-color: var(--user-msg-bg);
            border-color: var(--primary-light);
        }

        .option-btn.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .option-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .service-price {
            font-weight: 600;
            color: var(--accent-color);
        }

        .service-duration {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: 8px;
        }

        /* Input Area */
        .input-container {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .input-container.hidden {
            display: none;
        }

        .chat-input {
            flex: 1;
            padding: 16px 20px;
            background-color: var(--card-dark);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-light);
            font-size: 16px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0 24px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-btn:hover {
            background-color: var(--primary-dark);
        }

        .send-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        /* Success Message */
        .success-container {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--accent-color);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            margin-top: 20px;
            display: none;
        }

        .success-container.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .success-icon {
            font-size: 48px;
            color: var(--accent-color);
            margin-bottom: 20px;
        }

        .success-container h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--text-light);
        }

        .success-container p {
            color: var(--text-muted);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .appointment-details {
            background-color: var(--card-dark);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .detail-label {
            color: var(--text-muted);
        }

        .detail-value {
            color: var(--text-light);
            font-weight: 600;
        }

        .new-booking-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 25px;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .new-booking-btn:hover {
            background-color: var(--primary-dark);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }

        .typing-indicator.show {
            display: flex;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-muted);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingAnimation {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.5; }
            40% { transform: translateY(-10px); opacity: 1; }
        }

        /* Error Message */
        .error-message {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error-color);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            color: var(--error-color);
            display: none;
        }

        .error-message.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .warning-message {
            background-color: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning-color);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            color: var(--warning-color);
        }

        /* Help Button */
        .help-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(138, 43, 226, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-btn:hover {
            background-color: var(--primary-dark);
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(138, 43, 226, 0.4);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            justify-content: center;
            padding: 20px;
        }

        .loading-spinner.show {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Date Selector */
        .date-selector {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .date-btn {
            background-color: var(--card-dark);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            min-width: 120px;
            text-align: center;
        }

        .date-btn:hover {
            background-color: var(--user-msg-bg);
            border-color: var(--primary-light);
        }

        .date-btn.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .date-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .business-info {
                align-items: flex-start;
            }

            .chat-messages {
                max-height: 400px;
            }

            .message {
                max-width: 90%;
            }

            .chat-options {
                grid-template-columns: 1fr;
            }

            .date-selector {
                flex-direction: column;
            }

            .date-btn {
                min-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 15px;
            }

            .chat-header h2 {
                font-size: 24px;
            }

            .input-container {
                flex-direction: column;
            }

            .send-btn {
                padding: 16px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <h1>Agendame</h1>
            </div>

            <div class="business-info">
                <div class="business-name" id="businessName">Carregando...</div>
                <div class="business-type" id="businessType">Carregando...</div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="chat-container">
            <div class="chat-header">
                <h2>Agendamento Online</h2>
                <p>Faça seu agendamento de forma rápida e fácil. Responda algumas perguntas e escolha o horário que melhor se encaixa na sua agenda.</p>
            </div>

            <!-- Error Message -->
            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
            </div>

            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here by JavaScript -->
            </div>

            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>

            <!-- Chat Input -->
            <div class="input-container" id="inputContainer">
                <input type="text" class="chat-input" id="chatInput" placeholder="Digite sua resposta aqui..." autocomplete="off" disabled>
                <button class="send-btn" id="sendBtn" disabled>
                    <i class="fas fa-paper-plane"></i> Enviar
                </button>
            </div>

            <!-- Success Message -->
            <div class="success-container" id="successContainer">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>Agendamento Confirmado!</h3>
                <p>Seu horário foi reservado com sucesso. Você receberá uma confirmação por WhatsApp. Em caso de necessidade de cancelamento, entre em contato com pelo menos 2 horas de antecedência.</p>

                <div class="appointment-details" id="appointmentDetails">
                    <!-- Appointment details will be added here -->
                </div>

                <button class="new-booking-btn" id="newBookingBtn">
                    <i class="fas fa-plus"></i> Fazer Novo Agendamento
                </button>
            </div>
        </div>
    </div>

    <!-- Help Button -->
    <button class="help-btn" id="helpBtn" title="Ajuda">
        <i class="fas fa-question"></i>
    </button>

    <script>
        // Obter slug da empresa da URL
        const pathParts = window.location.pathname.split('/');
        const companySlug = pathParts[pathParts.length - 1];

        // Estado do chat
        const chatState = {
            step: -1, // -1 = carregando, 0 = nome, 1 = telefone, 2 = serviço, 3 = data, 4 = horário, 5 = finalizado
            userName: "",
            userPhone: "",
            selectedService: null,
            selectedDate: null,
            selectedTime: null,
            clientId: null,
            companyInfo: null,
            services: [],
            availableDates: [],
            availableSlots: [],
            isLoading: false
        };

        // Elementos DOM
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const inputContainer = document.getElementById('inputContainer');
        const typingIndicator = document.getElementById('typingIndicator');
        const successContainer = document.getElementById('successContainer');
        const appointmentDetails = document.getElementById('appointmentDetails');
        const newBookingBtn = document.getElementById('newBookingBtn');
        const businessName = document.getElementById('businessName');
        const businessType = document.getElementById('businessType');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const helpBtn = document.getElementById('helpBtn');

        // Inicializar a aplicação
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Carregar informações da empresa
                await loadCompanyInfo();

                // Configurar eventos
                setupEventListeners();

                // Iniciar o chat
                startChat();

            } catch (error) {
                console.error('Erro ao inicializar:', error);
                showErrorMessage('Erro ao carregar informações da empresa. Por favor, tente novamente.');
            }
        });

        // Configurar event listeners
        function setupEventListeners() {
            sendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleSendMessage();
                }
            });

            newBookingBtn.addEventListener('click', resetChat);
            helpBtn.addEventListener('click', showHelpOptions);

            // Habilitar input quando usuário começar a digitar
            chatInput.addEventListener('input', function() {
                if (chatInput.value.trim().length > 0) {
                    sendBtn.disabled = false;
                } else {
                    sendBtn.disabled = true;
                }
            });
        }

        // Carregar informações da empresa
        async function loadCompanyInfo() {
            showLoading(true);
            try {
                const response = await fetch(`/agendame/${companySlug}/info`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Empresa não encontrada');
                }

                const data = await response.json();
                chatState.companyInfo = data.company;
                chatState.services = data.services;

                // Atualizar header
                businessName.textContent = chatState.companyInfo.name;
                businessType.textContent = chatState.companyInfo.type;

            } catch (error) {
                console.error('Erro ao carregar empresa:', error);
                showErrorMessage(error.message || 'Empresa não encontrada. Verifique o link de agendamento.');
                throw error;
            } finally {
                showLoading(false);
            }
        }

        // Iniciar o chat
        function startChat() {
            if (!chatState.companyInfo) {
                addMessageToChat("Desculpe, não foi possível carregar as informações da empresa. Por favor, tente novamente mais tarde.", "bot");
                return;
            }

            // Verificar se empresa está ativa
            // if (!chatState.companyInfo.available) {
            //     addMessageToChat("Esta empresa não está aceitando agendamentos no momento. Por favor, entre em contato diretamente.", "bot");
            //     return;
            // }

            addMessageToChat(`Olá! Bem-vindo ao sistema de agendamento da ${chatState.companyInfo.name}.`, "bot");

            // Aguardar um pouco e enviar a primeira pergunta
            setTimeout(() => {
                askForName();
            }, 800);
        }

        // Adicionar mensagem ao chat
        function addMessageToChat(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;

            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            messageDiv.innerHTML = `
                <div class="message-content">${text}</div>
                <div class="message-time">${timeString}</div>
            `;

            chatMessages.appendChild(messageDiv);

            // Scroll para a última mensagem
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Mostrar indicador de digitação
        function showTypingIndicator() {
            typingIndicator.classList.add('show');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Esconder indicador de digitação
        function hideTypingIndicator() {
            typingIndicator.classList.remove('show');
        }

        // Mostrar loading
        function showLoading(show) {
            if (show) {
                loadingSpinner.classList.add('show');
                chatInput.disabled = true;
                sendBtn.disabled = true;
            } else {
                loadingSpinner.classList.remove('show');
                chatInput.disabled = false;
            }
        }

        // Mostrar mensagem de erro
        function showErrorMessage(message) {
            errorText.textContent = message;
            errorMessage.classList.add('show');
        }

        // Esconder mensagem de erro
        function hideErrorMessage() {
            errorMessage.classList.remove('show');
        }

        // Perguntar o nome
        function askForName() {
            showTypingIndicator();

            setTimeout(() => {
                hideTypingIndicator();
                hideErrorMessage();
                addMessageToChat("Para começarmos, por favor, informe seu nome completo:", "bot");
                chatState.step = 0;
                enableInput();
                chatInput.focus();
                chatInput.placeholder = "Digite seu nome completo...";
            }, 1000);
        }

        // Perguntar o telefone
        function askForPhone() {
            showTypingIndicator();

            setTimeout(() => {
                hideTypingIndicator();
                addMessageToChat(`Perfeito, ${chatState.userName}! Agora preciso do seu telefone (com DDD):`, "bot");
                chatState.step = 1;
                enableInput();
                chatInput.focus();
                chatInput.placeholder = "Ex: 11999998888";
            }, 1000);
        }

        // Perguntar o serviço
        function askForService() {
            showTypingIndicator();

            setTimeout(() => {
                hideTypingIndicator();

                if (chatState.services.length === 0) {
                    showNoServicesMessage();
                    return;
                }

                addMessageToChat("Agora, qual serviço você gostaria de agendar?", "bot");

                // Criar opções de serviços
                const servicesHtml = chatState.services.map(service => {
                    const durationText = service.duration ? `${service.duration}min` : '60min';
                    return `
                        <button class="option-btn" data-service-id="${service.id}">
                            <div>
                                <div class="service-name">${service.name}</div>
                                <div class="service-duration">${durationText}</div>
                            </div>
                            <div class="service-price">R$ ${parseFloat(service.price).toFixed(2)}</div>
                        </button>
                    `;
                }).join('');

                addMessageToChat(`
                    <div class="chat-options" id="serviceOptions">
                        ${servicesHtml}
                    </div>
                `, "bot");

                // Adicionar event listeners aos botões de serviço
                setTimeout(() => {
                    document.querySelectorAll('#serviceOptions .option-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const serviceId = parseInt(this.getAttribute('data-service-id'));
                            selectService(serviceId);
                        });
                    });
                }, 100);

                chatState.step = 2;
                disableInput();
            }, 1000);
        }

        // Carregar datas disponíveis
        async function loadAvailableDates(serviceId = null) {
            showLoading(true);
            try {
                let url = `/agendame/${companySlug}/availability`;
                if (serviceId) {
                    url += `?service_id=${serviceId}`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error('Erro ao carregar datas disponíveis');

                const data = await response.json();

                // Se houver slots disponíveis hoje, usar hoje
                if (data.available_slots && data.available_slots.length > 0) {
                    chatState.selectedDate = data.date;
                    return [data.date];
                }

                // Se não, buscar próximos dias
                const dates = [];
                const today = new Date();
                for (let i = 1; i <= 7; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() + i);
                    dates.push(date.toISOString().split('T')[0]);
                }

                return dates;

            } catch (error) {
                console.error('Erro ao carregar datas:', error);
                return [];
            } finally {
                showLoading(false);
            }
        }

        // Perguntar a data
        async function askForDate() {
            showTypingIndicator();

            setTimeout(async () => {
                hideTypingIndicator();

                const selectedService = chatState.services.find(s => s.id === chatState.selectedService);

                // Carregar datas disponíveis
                const dates = await loadAvailableDates(chatState.selectedService);

                if (dates.length === 0) {
                    addMessageToChat(`Infelizmente não há datas disponíveis para ${selectedService.name} nos próximos 7 dias.`, "bot");
                    addMessageToChat(`
                        <div class="chat-options">
                            <button class="option-btn" id="chooseAnotherService">Escolher outro serviço</button>
                            <button class="option-btn" id="contactBusiness">Entrar em contato</button>
                        </div>
                    `, "bot");

                    setTimeout(() => {
                        document.getElementById('chooseAnotherService').addEventListener('click', () => {
                            askForService();
                        });
                        document.getElementById('contactBusiness').addEventListener('click', () => {
                            window.open(`tel:${chatState.companyInfo.phone}`, '_blank');
                        });
                    }, 100);
                    return;
                }

                addMessageToChat(`Perfeito! Agora escolha uma data para o serviço: ${selectedService.name}`, "bot");

                // Criar opções de datas
                const datesHtml = dates.map(date => {
                    const dateObj = new Date(date);
                    const day = dateObj.getDate().toString().padStart(2, '0');
                    const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                    const weekday = getWeekdayName(dateObj.getDay());
                    const formattedDate = `${day}/${month}`;

                    return `
                        <button class="date-btn" data-date="${date}">
                            ${weekday}<br>
                            <strong>${formattedDate}</strong>
                        </button>
                    `;
                }).join('');

                addMessageToChat(`
                    <div class="date-selector" id="dateOptions">
                        ${datesHtml}
                    </div>
                `, "bot");

                // Adicionar event listeners aos botões de data
                setTimeout(() => {
                    document.querySelectorAll('#dateOptions .date-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const date = this.getAttribute('data-date');
                            selectDate(date);
                        });
                    });
                }, 100);

                chatState.step = 3;
            }, 1000);
        }

        // Carregar horários disponíveis
        async function loadAvailableSlots(date, serviceId = null) {
            showLoading(true);
            try {
                let url = `/agendame/${companySlug}/availability?date=${date}`;
                if (serviceId) {
                    url += `&service_id=${serviceId}`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error('Erro ao carregar horários');

                const data = await response.json();
                return data.available_slots || [];

            } catch (error) {
                console.error('Erro ao carregar horários:', error);
                return [];
            } finally {
                showLoading(false);
            }
        }

        // Perguntar o horário
        async function askForTime() {
            showTypingIndicator();

            setTimeout(async () => {
                hideTypingIndicator();

                const selectedService = chatState.services.find(s => s.id === chatState.selectedService);
                const formattedDate = formatDateForDisplay(chatState.selectedDate);

                // Carregar horários disponíveis
                const slots = await loadAvailableSlots(chatState.selectedDate, chatState.selectedService);

                if (slots.length === 0) {
                    addMessageToChat(`Infelizmente não há horários disponíveis para ${selectedService.name} na data ${formattedDate}.`, "bot");
                    addMessageToChat(`
                        <div class="chat-options">
                            <button class="option-btn" id="chooseAnotherDate">Escolher outra data</button>
                            <button class="option-btn" id="chooseAnotherService">Escolher outro serviço</button>
                        </div>
                    `, "bot");

                    setTimeout(() => {
                        document.getElementById('chooseAnotherDate').addEventListener('click', () => {
                            askForDate();
                        });
                        document.getElementById('chooseAnotherService').addEventListener('click', () => {
                            askForService();
                        });
                    }, 100);
                    return;
                }

                addMessageToChat(`Excelente! Agora escolha um horário para ${formattedDate}:`, "bot");

                // Criar opções de horários
                const timesHtml = slots.map(slot => {
                    const recommended = slot.is_recommended ? '⭐ ' : '';
                    const available = slot.available ? '' : 'disabled';
                    return `
                        <button class="option-btn" data-time="${slot.time}" ${available}>
                            ${recommended}${slot.time}
                        </button>
                    `;
                }).join('');

                addMessageToChat(`
                    <div class="chat-options" id="timeOptions">
                        ${timesHtml}
                    </div>
                `, "bot");

                // Adicionar event listeners aos botões de horário
                setTimeout(() => {
                    document.querySelectorAll('#timeOptions .option-btn:not(:disabled)').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const time = this.getAttribute('data-time');
                            selectTime(time);
                        });
                    });
                }, 100);

                chatState.step = 4;
            }, 1000);
        }

        // Cadastrar cliente no sistema
        async function registerClient() {
            showLoading(true);

            try {
                const response = await fetch(`/agendame/${companySlug}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        full_name: chatState.userName,
                        phone: chatState.userPhone,
                        service_id: chatState.selectedService,
                        preferred_time: chatState.selectedTime,
                        total_appointments: 0,
                        notes: "Agendamento via site"
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Erro ao cadastrar cliente');
                }

                const data = await response.json();
                chatState.clientId = data.client_id;

                // Mostrar confirmação
                showLoading(false);
                completeBooking(data);

            } catch (error) {
                showLoading(false);
                console.error('Erro ao cadastrar cliente:', error);
                addMessageToChat(`Desculpe, ocorreu um erro: ${error.message}.`, "bot");

                // Oferecer opção de recomeçar
                addMessageToChat(`
                    <div class="chat-options">
                        <button class="option-btn" id="tryAgain">Tentar novamente</button>
                        <button class="option-btn" id="contactSupport">Entrar em contato</button>
                    </div>
                `, "bot");

                setTimeout(() => {
                    document.getElementById('tryAgain').addEventListener('click', () => {
                        askForTime();
                    });
                    document.getElementById('contactSupport').addEventListener('click', () => {
                        window.open(`tel:${chatState.companyInfo.phone}`, '_blank');
                    });
                }, 100);
            }
        }

        // Finalizar agendamento
        function completeBooking(data) {
            addMessageToChat(`Agendamento confirmado! Um resumo do seu agendamento será exibido em instantes.`, "bot");

            // Mostrar sucesso após um breve delay
            setTimeout(() => {
                showSuccessMessage(data);
            }, 1500);

            chatState.step = 5;
            disableInput();
        }

        // Selecionar serviço
        function selectService(serviceId) {
            // Remover seleção anterior
            if (document.querySelector('#serviceOptions')) {
                document.querySelectorAll('#serviceOptions .option-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            }

            // Marcar como selecionado
            const selectedBtn = document.querySelector(`#serviceOptions .option-btn[data-service-id="${serviceId}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }

            const selectedService = chatState.services.find(s => s.id === serviceId);
            chatState.selectedService = serviceId;

            // Adicionar mensagem do usuário
            addMessageToChat(selectedService.name, "user");

            // Aguardar e perguntar data
            setTimeout(() => {
                askForDate();
            }, 800);
        }

        // Selecionar data
        function selectDate(date) {
            // Remover seleção anterior
            if (document.querySelector('#dateOptions')) {
                document.querySelectorAll('#dateOptions .date-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            }

            // Marcar como selecionado
            const selectedBtn = document.querySelector(`#dateOptions .date-btn[data-date="${date}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }

            chatState.selectedDate = date;

            // Adicionar mensagem do usuário
            const formattedDate = formatDateForDisplay(date);
            addMessageToChat(formattedDate, "user");

            // Aguardar e perguntar horário
            setTimeout(() => {
                askForTime();
            }, 800);
        }

        // Selecionar horário
        function selectTime(time) {
            // Remover seleção anterior
            if (document.querySelector('#timeOptions')) {
                document.querySelectorAll('#timeOptions .option-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            }

            // Marcar como selecionado
            const selectedBtn = document.querySelector(`#timeOptions .option-btn[data-time="${time}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }

            chatState.selectedTime = time;

            // Adicionar mensagem do usuário
            addMessageToChat(time, "user");

            // Aguardar e cadastrar cliente
            setTimeout(() => {
                registerClient();
            }, 800);
        }

        // Processar envio de mensagem
        function handleSendMessage() {
            const message = chatInput.value.trim();

            if (!message) return;

            // Adicionar mensagem do usuário ao chat
            addMessageToChat(message, "user");

            // Processar de acordo com o passo atual
            if (chatState.step === 0) {
                // Validar nome
                if (message.length < 3) {
                    addMessageToChat("Por favor, informe seu nome completo (mínimo 3 caracteres):", "bot");
                    return;
                }

                chatState.userName = message;
                chatInput.value = "";
                sendBtn.disabled = true;

                // Aguardar e perguntar telefone
                setTimeout(() => {
                    askForPhone();
                }, 800);

            } else if (chatState.step === 1) {
                // Validar telefone
                const phoneRegex = /^\d{10,11}$/;
                const digits = message.replace(/\D/g, '');

                if (!phoneRegex.test(digits)) {
                    addMessageToChat("Por favor, informe um telefone válido com DDD (10 ou 11 dígitos):", "bot");
                    return;
                }

                chatState.userPhone = digits;
                chatInput.value = "";
                sendBtn.disabled = true;

                // Aguardar e perguntar serviço
                setTimeout(() => {
                    askForService();
                }, 800);
            }

            // Limpar input
            chatInput.value = "";
        }

        // Mostrar mensagem de sucesso
        function showSuccessMessage(data) {
            const selectedService = chatState.services.find(s => s.id === chatState.selectedService);
            const formattedDate = formatDateForDisplay(chatState.selectedDate);

            // Criar detalhes do agendamento
            const detailsHtml = `
                <div class="detail-row">
                    <span class="detail-label">Código do Agendamento:</span>
                    <span class="detail-value">${data.client_id || 'AG' + Date.now().toString().slice(-6)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Cliente:</span>
                    <span class="detail-value">${chatState.userName}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Telefone:</span>
                    <span class="detail-value">${formatPhone(chatState.userPhone)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Serviço:</span>
                    <span class="detail-value">${selectedService ? selectedService.name : 'Não especificado'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Valor:</span>
                    <span class="detail-value">R$ ${selectedService ? parseFloat(selectedService.price).toFixed(2) : '--'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Data:</span>
                    <span class="detail-value">${formattedDate}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Horário:</span>
                    <span class="detail-value">${chatState.selectedTime}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Empresa:</span>
                    <span class="detail-value">${chatState.companyInfo.name}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Telefone:</span>
                    <span class="detail-value">${formatPhone(chatState.companyInfo.phone)}</span>
                </div>
            `;

            appointmentDetails.innerHTML = detailsHtml;

            // Esconder chat e mostrar sucesso
            inputContainer.classList.add('hidden');
            successContainer.classList.add('show');

            // Scroll para o topo da seção de sucesso
            successContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Habilitar input
        function enableInput() {
            chatInput.disabled = false;
            chatInput.focus();
            sendBtn.disabled = chatInput.value.trim().length === 0;
        }

        // Desabilitar input
        function disableInput() {
            chatInput.disabled = true;
            sendBtn.disabled = true;
        }

        // Mostrar mensagem de nenhum serviço
        function showNoServicesMessage() {
            addMessageToChat("No momento não há serviços disponíveis para agendamento.", "bot");

            addMessageToChat(`
                <div class="warning-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    Entre em contato com a empresa para mais informações.
                </div>
            `, "bot");

            // Oferecer opção de contatar a empresa
            addMessageToChat(`
                <div class="chat-options">
                    <button class="option-btn" id="contactForServices">
                        <i class="fas fa-phone"></i> Entrar em contato
                    </button>
                    <button class="option-btn" id="tryLater">
                        <i class="fas fa-clock"></i> Tentar mais tarde
                    </button>
                </div>
            `, "bot");

            setTimeout(() => {
                document.getElementById('contactForServices').addEventListener('click', () => {
                    window.open(`tel:${chatState.companyInfo.phone}`, '_blank');
                });

                document.getElementById('tryLater').addEventListener('click', () => {
                    addMessageToChat("Volte mais tarde para verificar a disponibilidade de serviços.", "bot");
                });
            }, 100);
        }

        // Mostrar opções de ajuda
        function showHelpOptions() {
            addMessageToChat("Como posso ajudá-lo?", "bot");
            addMessageToChat(`
                <div class="chat-options">
                    <button class="option-btn" id="contactBusiness">
                        <i class="fas fa-phone"></i> Falar com a empresa
                    </button>
                    <button class="option-btn" id="viewServices">
                        <i class="fas fa-cut"></i> Ver serviços
                    </button>
                    <button class="option-btn" id="restartProcess">
                        <i class="fas fa-redo"></i> Reiniciar
                    </button>
                </div>
            `, "bot");

            setTimeout(() => {
                document.getElementById('contactBusiness').addEventListener('click', () => {
                    window.open(`tel:${chatState.companyInfo.phone}`, '_blank');
                });

                document.getElementById('viewServices').addEventListener('click', () => {
                    askForService();
                });

                document.getElementById('restartProcess').addEventListener('click', () => {
                    resetChat();
                });
            }, 100);
        }

        // Funções utilitárias
        function formatDateForDisplay(dateString) {
            const date = new Date(dateString);
            const days = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

            return `${days[date.getDay()]}, ${date.getDate()} de ${months[date.getMonth()]}`;
        }

        function getWeekdayName(dayIndex) {
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            return days[dayIndex];
        }

        function formatPhone(phone) {
            if (!phone) return '';
            const digits = phone.replace(/\D/g, '');
            if (digits.length === 10) {
                return `(${digits.slice(0,2)}) ${digits.slice(2,6)}-${digits.slice(6)}`;
            } else if (digits.length === 11) {
                return `(${digits.slice(0,2)}) ${digits.slice(2,7)}-${digits.slice(7)}`;
            }
            return phone;
        }

        // Reiniciar o chat para novo agendamento
        function resetChat() {
            // Resetar estado
            chatState.step = -1;
            chatState.userName = "";
            chatState.userPhone = "";
            chatState.selectedService = null;
            chatState.selectedDate = null;
            chatState.selectedTime = null;
            chatState.clientId = null;
            chatState.availableSlots = [];
            chatState.availableDates = [];

            // Limpar mensagens
            chatMessages.innerHTML = '';

            // Esconder sucesso e mostrar input
            successContainer.classList.remove('show');
            inputContainer.classList.remove('hidden');
            hideErrorMessage();

            // Reiniciar chat
            startChat();
        }
    </script>
</body>
</html>
