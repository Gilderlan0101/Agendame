name: Keep Render Alive

on:
  schedule:
    # Roda a cada 6 minutos
    - cron: '*/6 * * * *'
  
  workflow_dispatch:
  
  # Opcional: roda quando vocÃª faz push
  push:
    branches: [ main, master ]

jobs:
  keep-alive:
    name: ğŸ”‹ Manter Render Ativo
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‹ Verificar cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ“¡ Pingar endpoints
      run: |
        echo "ğŸš€ Iniciando keep-alive para Render.com"
        echo "========================================"
        
        # ConfiguraÃ§Ãµes
        BASE_URL="https://agendame.onrender.com"
        ENDPOINTS=("/health" "/ping" "/keepalive" "/")
        TIMEOUT=20
        SUCCESS=0
        
        for endpoint in "${ENDPOINTS[@]}"; do
          URL="${BASE_URL}${endpoint}"
          echo ""
          echo "ğŸ‘‰ Testando: $URL"
          
          # Usar wget como alternativa se curl falhar
          if command -v curl &> /dev/null; then
            CMD="curl"
          else
            CMD="wget -qO-"
          fi
          
          if $CMD -s \
               --max-time $TIMEOUT \
               --retry 1 \
               -H "Accept: application/json" \
               "$URL" > /dev/null 2>&1; then
            echo "âœ… Respondeu"
            SUCCESS=1
          else
            echo "â­ï¸  Sem resposta (normal para free tier)"
          fi
          
          # Pequena pausa
          sleep 0.5
        done
        
        echo ""
        echo "========================================"
        
        if [ $SUCCESS -eq 1 ]; then
          echo "ğŸ‰ Servidor estÃ¡ respondendo!"
          echo "ğŸ“… PrÃ³ximo ping: $(date -d '+6 minutes' '+%H:%M:%S')"
          exit 0
        else
          echo "âš ï¸  AtenÃ§Ã£o: Nenhum endpoint respondeu"
          echo "ğŸ’¡ O servidor pode estar iniciando ou offline"
          echo "ğŸ”„ Tentando novamente em 6 minutos..."
          exit 0  # NÃ£o falha, apenas tenta novamente depois
        fi
    
    - name: ğŸ“ Registrar execuÃ§Ã£o
      if: always()
      run: |
        echo "ğŸ Workflow executado em: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "ğŸ”— ServiÃ§o: https://agendame.onrender.com"
        echo "â° FrequÃªncia: A cada 6 minutos"
